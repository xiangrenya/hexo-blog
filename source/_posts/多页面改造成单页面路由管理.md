---
layout: post
title:  "多页面改造成单页面路由管理"
date:   2019-08-10
categories: 前端
comments: true
---

多页面带来的构建速度的降低，前端资源包的体积变大，维护成本的上升，所以需要把之前遗留的多页面项目，改造成单页面路由管理。

入口 index 目录

├── generator.js
├── main.jsx
├── routes.js
└── template.ejs

生成 routes.js 文件的脚本 generator.js

``` javascript
const fs = require('fs');
const path = require('path');
const ejs = require('ejs');

let modules = fs.readdirSync(path.join(__dirname, '../../modules'), 'utf8');
modules = modules.filter(module => !['index'].includes(module));

const template = fs.readFileSync(path.join(__dirname, '/template.ejs'), 'utf8');
const content = ejs.compile(template)({ modules });

fs.writeFile('routes.js', content, err => {
    if (err) {
        console.log(err);
    } else {
        console.log('写入成功！');
    }
});
```

路由模板 template.ejs

```javascript
<%
    function firstUpperCase(str) {
        return str.replace(/\b\w+\b/g, function(word){
            return word.substring(0,1).toUpperCase() + word.substring(1);
        }).replace(/\-/g, '');
    }
%>
import { lazy } from 'react';
<% for (var i=0; i<modules.length; i++) { %>
const <%= firstUpperCase(modules[i]) %> = lazy(() => import('../<%= modules[i] %>/main.jsx'));
<% } %>

const routes = [
    <% for (var i=0; i<modules.length; i++) { %>
    {
        name: '<%= modules[i] %>',
        path: '/<%= modules[i] %>',
        component: <%= firstUpperCase(modules[i]) %>
    },
    <% } %>
];

export default routes;
```

引入路由的 Main.jsx

```javascript
class Main extends React.Component {
    render() {
        return (
            <HashRouter>
                <Suspense fallback={<div>...</div>}>
                    <Switch>
                        {routes.map((route, index) => {
                            return <Route key={index} path={route.path} exact={true} component={route.component} />;
                        })}
                        <Route exact path='/' component={Index} />
                        <Route component={Index} />
                    </Switch>
                </Suspense>
            </HashRouter>
        );
    }
}

export default Main;
```